<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4 Image processing | masmr: Modular Algorithms for Spotcalling in MERFISH in R</title>
<meta name="author" content="Eugene Kwa">
<meta name="description" content="One key decision in your spotcalling script is choosing how to process your images. Here, we will cover the image processing functions that {masmr} provides, and how users may string together...">
<meta name="generator" content="bookdown 0.43.2 with bs4_book()">
<meta property="og:title" content="4 Image processing | masmr: Modular Algorithms for Spotcalling in MERFISH in R">
<meta property="og:type" content="book">
<meta property="og:image" content="/./images/masmr.png">
<meta property="og:description" content="One key decision in your spotcalling script is choosing how to process your images. Here, we will cover the image processing functions that {masmr} provides, and how users may string together...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4 Image processing | masmr: Modular Algorithms for Spotcalling in MERFISH in R">
<meta name="twitter:description" content="One key decision in your spotcalling script is choosing how to process your images. Here, we will cover the image processing functions that {masmr} provides, and how users may string together...">
<meta name="twitter:image" content="/./images/masmr.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="libs/bslib-component-js-0.9.0/components.min.js"></script><script src="libs/bslib-component-js-0.9.0/web-components.min.js" type="module"></script><link href="libs/bslib-component-css-0.9.0/components.css" rel="stylesheet">
<script src="libs/bslib-tag-require-0.9.0/tag-require.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">masmr: Modular Algorithms for Spotcalling in MERFISH in R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> About masmr</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">2</span> Introduction</a></li>
<li><a class="" href="spotcalling.html"><span class="header-section-number">3</span> Spotcalling</a></li>
<li><a class="active" href="image-processing.html"><span class="header-section-number">4</span> Image processing</a></li>
<li><a class="" href="cell-segmentation.html"><span class="header-section-number">5</span> Cell segmentation</a></li>
<li><a class="" href="stitching.html"><span class="header-section-number">6</span> Stitching</a></li>
<li><a class="" href="synthesis.html"><span class="header-section-number">7</span> Synthesis</a></li>
<li><a class="" href="troubleshooting.html"><span class="header-section-number">8</span> Troubleshooting</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="image-processing" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Image processing<a class="anchor" aria-label="anchor" href="#image-processing"><i class="fas fa-link"></i></a>
</h1>
<p>One key decision in your spotcalling script is choosing how to process your images. Here, we will cover the image processing functions that {masmr} provides, and how users may string together these functions for their own purposes.</p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">masmr</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div id="pre-processing-1" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing-1"><i class="fas fa-link"></i></a>
</h2>
<p>As before, specify your parameters. [Parameters hashed out below are those that will be automatically inferred from the default.]</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">=</span> <span class="st">'C:/Users/kwaje/Downloads/JIN_SIM/20190718_WK_T2_a_B2_R8_12_d50/'</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/establishParams.html">establishParams</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co">## User to fill in</span></span>
<span>  imageDirs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">'S10/'</span><span class="op">)</span>,</span>
<span>  imageFormat <span class="op">=</span> <span class="st">'.ome.tif'</span>,</span>
<span>  outDir <span class="op">=</span> <span class="st">'C:/Users/kwaje/Downloads/JYOUT/'</span>,</span>
<span>  codebookFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>,<span class="st">'codebook/'</span><span class="op">)</span>,pattern<span class="op">=</span><span class="st">'codebook'</span>,full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  dapiDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">'DAPI_1/'</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co">## Will attempt automatic fill</span></span>
<span>  <span class="co"># metaFormat = '.ome.tif',</span></span>
<span>  <span class="co"># dapiFormat = '.ome.tif',</span></span>
<span>  codebookColumnNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span>,<span class="st">'_'</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cy3'</span>,<span class="st">'alexa594'</span>,<span class="st">'cy5'</span>,<span class="st">'cy7'</span><span class="op">)</span>,each<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  pythonLocation <span class="op">=</span> <span class="st">'C:/Users/kwaje/AppData/Local/miniforge3/envs/scipyenv/'</span>,</span>
<span>  </span>
<span>  <span class="co">## Automatically filled</span></span>
<span>  <span class="co"># seed = 12345,</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="co"># resumeMode = TRUE,</span></span>
<span>  </span>
<span>  <span class="co">## Optional (but recommended for QC checks)</span></span>
<span>  fpkmFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"FPKM_data/Jin_FPKMData_B.tsv"</span><span class="op">)</span>,</span>
<span>  nProbesFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"ProbesPerGene.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## Assuming .ome.tif is extension for meta files...</code></pre>
<p>Image processing is handled <em>within</em> your spotcalling script, and consequently requires some pre-processing to have been done prior to looping through images. These are provided below (kindly refer to Chapter <a href="spotcalling.html#spotcalling">3</a> for details).</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Necessary pre-processing done before your loop</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/readImageMetaData.html">readImageMetaData</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in readImageMetaData(): Updating params$fov_names</code></pre>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/prepareCodebook.html">prepareCodebook</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getAnchorParams.html">getAnchorParams</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/establishCleanSlate.html">establishCleanSlate</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] ".Random.seed" "data_dir"     "params"</code></pre>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Specify the current FOV (done inside the loop)</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">current_fov</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">fov_names</span><span class="op">[</span><span class="fl">38</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Read the images for your current FOV (done inside loop)</span></span>
<span><span class="va">imList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/readImageList.html">readImageList</a></span><span class="op">(</span> <span class="va">params</span><span class="op">$</span><span class="va">current_fov</span> <span class="op">)</span></span></code></pre></div>
</div>
<div id="building-blocks-of-image-processing" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Building blocks of image processing<a class="anchor" aria-label="anchor" href="#building-blocks-of-image-processing"><i class="fas fa-link"></i></a>
</h2>
<p>The backbone of MERFISH pipelines is image processing. We provide several options, which we will showcase with the test image below. Note the use of <code><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">imager::as.cimg</a></code>, which converts image matrices to <code>.cimg</code> objects that are read by C++; so doing allows for rapid manipulation and plotting.</p>
<p><strong>ALWAYS plot to check how your image processing has altered your image!</strong></p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">im</span> <span class="op">&lt;-</span> <span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Unaltered image'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span> <span class="va">im</span>, breaks<span class="op">=</span><span class="fl">1000</span>, main <span class="op">=</span> <span class="st">'Unaltered image'</span>, xlab<span class="op">=</span><span class="st">'Intensities'</span>, ylab<span class="op">=</span><span class="st">'N pixels'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-unaltered-1.png" width="672"></div>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="imnormalise" class="section level3 unnumbered">
<h3>
<code>imNormalise</code><a class="anchor" aria-label="anchor" href="#imnormalise"><i class="fas fa-link"></i></a>
</h3>
<p>Note the range of raw intensities. We can use <code>imNormalise</code> to perform a quick min-max normalisation so that values span 0 to 1.</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Min-max image'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span> <span class="va">norm</span>, breaks<span class="op">=</span><span class="fl">1000</span>, main <span class="op">=</span> <span class="st">'Min-max image'</span>, xlab<span class="op">=</span><span class="st">'Intensities'</span>, ylab<span class="op">=</span><span class="st">'N pixels'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-minmax-1.png" width="672"></div>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Since we previously calculated min and max brightnesses, we may wish to winsorise intensity values (i.e. values trimmed to lie between min and max brightness). As before, we can use <code>imNormalise</code> but this time specifying the desired floor and ceiling values. [When these are unspecified, floor and ceiling values are defaulted to minimum and maximum intensities observed in the image, thereby performing a min-max normalisation.]</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">im</span>, floorVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_min</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ceilVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_max</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Winsorised image'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span> <span class="va">norm</span>, breaks<span class="op">=</span><span class="fl">1000</span>, main <span class="op">=</span> <span class="st">'Winsorised image'</span>, xlab<span class="op">=</span><span class="st">'Intensities'</span>, ylab<span class="op">=</span><span class="st">'N pixels'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-winsored-1.png" width="672"></div>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="imautobrighten" class="section level3 unnumbered">
<h3>
<code>imAutobrighten</code><a class="anchor" aria-label="anchor" href="#imautobrighten"><i class="fas fa-link"></i></a>
</h3>
<p>Brightening an image is accomplished by raising the intensities (that lie between 0 and 1) to some power <span class="math inline">\(x\)</span>, that maximises the distance between two user-specified values (<span class="math inline">\(floor\)</span> and <span class="math inline">\(ceiling\)</span>). The optimal <span class="math inline">\(x\)</span> is found by solving:</p>
<p><span class="math display">\[\begin{align}
\frac{d}{dx}\left(ceiling^x - floor^x\right) = 0 \\
ceiling^x \log{ceiling} - floor^x \log{floor} = 0 \\
x = \frac{\log{ \frac{\log{ceiling}}{\log{floor}}} }{ \log{\frac{floor}{ceiling}} }
\end{align}\]</span></p>
<p>Note that <code>imAutoBrighten</code> will only be valid if <code>floor</code> is more than 0 and <code>ceiling</code> is less than 1.</p>
<p>This is the basis of the <code>imAutoBrighten</code> function.</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imAutoBrighten.html">imAutoBrighten</a></span><span class="op">(</span><span class="va">im</span>, floorVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_min</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ceilVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_max</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Autobrightened image'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span> <span class="va">norm</span>, breaks<span class="op">=</span><span class="fl">1000</span>, main <span class="op">=</span> <span class="st">'Autobrightened image'</span>, xlab<span class="op">=</span><span class="st">'Intensities'</span>, ylab<span class="op">=</span><span class="st">'N pixels'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-autobright-1.png" width="672"></div>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="imlaplacianofgaussian" class="section level3 unnumbered">
<h3>
<code>imLaplacianOfGaussian</code><a class="anchor" aria-label="anchor" href="#imlaplacianofgaussian"><i class="fas fa-link"></i></a>
</h3>
<p>The difference of Gaussian blurs (i.e. Laplacian of Gaussians, LoG) is useful for correcting for uneven lighting or blob detection. This is accomplished by subtracting an image that has been slightly blurred (determined by the <code>smallBlur</code> parameter) from an image that is blurrier (<code>bigBlur</code>).</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">im</span>, smallBlur <span class="op">=</span> <span class="fl">1</span>, bigBlur <span class="op">=</span> <span class="fl">5</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Original image\n(Zoom in)'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Laplacian of Gaussians\n(Zoom in)'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-log-1.png" width="672"></div>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Values that are less than 0 are those dimmer that their immediate surroundings. Spots are typically brighter than their surroundings, and so typically have LoG &gt; 0.</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">im</span>, smallBlur <span class="op">=</span> <span class="fl">1</span>, bigBlur <span class="op">=</span> <span class="fl">5</span> <span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">norm</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Original image\n(Zoom in)'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Laplacian of Gaussians &gt;0\n(Zoom in)'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-logandnorm-1.png" width="672"></div>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="imhessiandeterminant" class="section level3 unnumbered">
<h3>
<code>imHessianDeterminant</code><a class="anchor" aria-label="anchor" href="#imhessiandeterminant"><i class="fas fa-link"></i></a>
</h3>
<p>The Hessian is a symmetric matrix containing second-order partial derivatives (i.e. gradient of gradients). In the context of images, it is a matrix of how intensity values are changing as we move along rows and columns of the image matrix. The determinant of the Hessian (detHess) is frequently used for blob detection – we have thus created a function that calculates its value:</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">im</span>, smallBlur <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Original image\n(Zoom in)'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'detHess\n(Zoom in)'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-hessdet-1.png" width="672"></div>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Thresholding detHess values are a quick way of detecting puncta:</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">im</span>, smallBlur <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="va">norm</span><span class="op">&gt;</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">norm</span>, <span class="fl">0.99</span><span class="op">)</span> <span class="co">##99 percentile of values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'detHess thresholded'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'detHess thresholded (Zoom in)'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-hessdetmask-1.png" width="672"></div>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Attentive readers would have noticed that there is a <code>smallBlur</code> parameter (default = 1) in the <code>imHessianDeterminant</code> function. This blur serves to denoise the image, so that detHess values are meaningful.</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Original image\n(Zoom in, no blur)'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1</span><span class="op">]</span>, smallBlur <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'detHess\n(Zoom in, no blur)'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">im</span><span class="op">[</span><span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1</span><span class="op">]</span>, smallBlur <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'detHess\n(Zoom in, slight blur)'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-hessdet-blurvnoblur-1.png" width="672"></div>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="imtvdenoise" class="section level4 unnumbered">
<h4>
<code>imTVDenoise</code><a class="anchor" aria-label="anchor" href="#imtvdenoise"><i class="fas fa-link"></i></a>
</h4>
<p>Total Variation (TV) denoising is an approach first described in 1992 <span class="citation">(<a href="troubleshooting.html#ref-rudin1992nonlinear" role="doc-biblioref">Rudin, Osher, and Fatemi 1992</a>)</span> to remove noise from an image while preserving edges. We have implemented the Chambolle algorithm <span class="citation">(<a href="troubleshooting.html#ref-chambolle2004algorithm" role="doc-biblioref">Chambolle 2004</a>)</span> (explained in further detail elsewhere <span class="citation">(<a href="troubleshooting.html#ref-chambolle2010introduction" role="doc-biblioref">Chambolle et al. 2010</a>; <a href="troubleshooting.html#ref-duran2013chambolle" role="doc-biblioref">Duran, Coll, and Sbert 2013</a>)</span>) which has shown to be fast, stable (i.e. relatively unchanged mean square error for different hyperparameters), and frequently outperforms other denoising approaches on astronomy data <span class="citation">(<a href="troubleshooting.html#ref-roscani2020comparative" role="doc-biblioref">Roscani et al. 2020</a>)</span>.</p>
<p>Currently, we have not used <code>imTVDenoise</code> as part of our default <code>getImageMetrics</code> pipeline (described later). Interested users can consider using this as an alternative to band-pass filtering or Gaussian smoothing (<code><a href="https://rdrr.io/pkg/imager/man/isoblur.html">imager::isoblur</a></code>) when creating their own image processing functions. The main tuning parameter for <code>imTVDenoise</code> is the <code>denoisingWeight</code> – with higher values reducing fidelity to the original image.</p>
<p>Note how denoising reduces the standard deviation of pixel intensities.</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toy_image</span> <span class="op">&lt;-</span> <span class="va">im</span><span class="op">[</span><span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1200</span><span class="op">:</span><span class="fl">1300</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">dW1</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="va">denoised1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imTVDenoise.html">imTVDenoise</a></span><span class="op">(</span><span class="va">toy_image</span>, denoisingWeight <span class="op">=</span> <span class="va">dW1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dW2</span> <span class="op">=</span> <span class="fl">0.01</span></span>
<span><span class="va">denoised2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imTVDenoise.html">imTVDenoise</a></span><span class="op">(</span><span class="va">toy_image</span>, denoisingWeight <span class="op">=</span> <span class="va">dW2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dW3</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">denoised3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imTVDenoise.html">imTVDenoise</a></span><span class="op">(</span><span class="va">toy_image</span>, denoisingWeight <span class="op">=</span> <span class="va">dW3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> </span>
<span>  <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'Original image\nIntensity SD: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">6</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> </span>
<span>  <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">denoised1</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'Denoised image (weight='</span>, <span class="va">dW1</span>, <span class="st">')\nIntensity SD: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">denoised1</span><span class="op">)</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">6</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> </span>
<span>  <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">denoised2</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'Denoised image (weight='</span>, <span class="va">dW2</span>, <span class="st">')\nIntensity SD: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">denoised2</span><span class="op">)</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">6</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> </span>
<span>  <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">denoised3</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'Denoised image (weight='</span>, <span class="va">dW3</span>, <span class="st">')\nIntensity SD: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">denoised3</span><span class="op">)</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">6</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-tvdenoising-1.png" width="1152"></div>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div id="advanced-creating-your-own-building-blocks" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Advanced: creating your own building blocks<a class="anchor" aria-label="anchor" href="#advanced-creating-your-own-building-blocks"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we will showcase several image processing vignettes for users with a good grasp of the basics and wishing to explore the topic in more depth. Some ideas covered here may be beyond the scope of the intended purpose of {masmr}, but a breadth of knowledge is often a good fuel for creativity.</p>
<p>For users only interested in the functionality of {masmr}, you may skip ahead (Section <a href="image-processing.html#combining-building-blocks">4.4</a>).</p>
<div id="the-benefits-of-using-complex-numbers-to-represent-coordinates" class="section level4 unnumbered">
<h4>The benefits of using complex numbers to represent coordinates<a class="anchor" aria-label="anchor" href="#the-benefits-of-using-complex-numbers-to-represent-coordinates"><i class="fas fa-link"></i></a>
</h4>
<p>Throughout {masmr} we frequently represent 2D coordinates as complex numbers, allowing us to make use of several in-built functions in base R to quickly get distances and angles.</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coordinates</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fl">1i</span>, <span class="op">-</span><span class="fl">1</span><span class="op">+</span><span class="fl">1i</span>, <span class="op">-</span><span class="fl">1</span><span class="op">-</span><span class="fl">1i</span>, <span class="fl">1</span><span class="op">-</span><span class="fl">1i</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">coordinate</span> <span class="kw">in</span> <span class="va">coordinates</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="va">coordinate</span>, </span>
<span>    <span class="st">' (real: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">coordinate</span><span class="op">)</span>, </span>
<span>    <span class="st">', imaginary: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">coordinate</span><span class="op">)</span>,</span>
<span>    <span class="st">') has length sqrt('</span>, <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">coordinate</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="st">')'</span>, <span class="co">#The length is automatically returned with Mod</span></span>
<span>    <span class="st">', and angle '</span>, <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">coordinate</span><span class="op">)</span> <span class="op">/</span> <span class="va">pi</span> <span class="op">*</span> <span class="fl">180</span>, <span class="st">' degrees'</span> <span class="co">#The default of Arg is in radians</span></span>
<span>  <span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] "1+1i (real: 1, imaginary: 1) has length sqrt(2), and angle 45 degrees"
## [1] "-1+1i (real: -1, imaginary: 1) has length sqrt(2), and angle 135 degrees"
## [1] "-1-1i (real: -1, imaginary: -1) has length sqrt(2), and angle -135 degrees"
## [1] "1-1i (real: 1, imaginary: -1) has length sqrt(2), and angle -45 degrees"</code></pre>
<p>Additionally, we can exploit the different ways to represent complex numbers to easily move between Cartesian and Polar coordinate systems…</p>
<p><span class="math display">\[\begin{align}
x + yi = r(\cos(theta) + i\sin(\theta)) = re^{i\theta}
\end{align}\]</span></p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span> <span class="fl">2</span> <span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">=</span> <span class="fl">45</span> <span class="op">/</span> <span class="fl">180</span> <span class="op">*</span> <span class="va">pi</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">complex</a></span><span class="op">(</span>real <span class="op">=</span> <span class="va">x</span>, imaginary <span class="op">=</span> <span class="va">y</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1+1i</code></pre>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1i</span><span class="op">*</span><span class="va">y</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1+1i</code></pre>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">complex</a></span><span class="op">(</span>modulus <span class="op">=</span> <span class="va">r</span>, argument <span class="op">=</span> <span class="va">theta</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1+1i</code></pre>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1+1i</code></pre>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="va">r</span> <span class="op">*</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span> <span class="va">theta</span> <span class="op">)</span> <span class="op">+</span> <span class="fl">1i</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1+1i</code></pre>
<p>…which make getting metrics such as distances and angles much easier.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toy_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">51</span>, ncol<span class="op">=</span><span class="fl">51</span><span class="op">)</span></span>
<span><span class="va">toy_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getRasterCoords.html">getRasterCoords</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span></span>
<span><span class="va">centre</span> <span class="op">=</span> <span class="fl">25</span><span class="op">+</span><span class="fl">25i</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">toy_coord</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'X coordinate'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">toy_coord</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Y coordinate'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Distance from centre'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Angle wrt centre'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_whycomplex_distanceswithpolar-1.png" width="1152"></div>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Sampling using Polar coordinate variables can also be incredibly helpful.</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">npts</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># Any value between 0 and 10</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span> <span class="co"># Every possible angle</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, main<span class="op">=</span><span class="st">'Circle'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">0.1</span>, max <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span> <span class="co"># Restricted angles</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, main<span class="op">=</span><span class="st">'Segment'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># Restricted lengths</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, main<span class="op">=</span><span class="st">'Annulus'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">)</span> <span class="co"># Exponential decay with distance</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, main<span class="op">=</span><span class="st">'Gaussian'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_whycomplex_sampling-1.png" width="1152"></div>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Taking the mean or median of complex number coordinates also quickly returns various “centres” of the point cloud. Below means are plusses (+) while medians are crosses (x). Those that are obtained by functions on complex numbers are red, while those obtained by functions on (x,y) individually are in blue.</p>
<p>Note how mean and median of (x,y) tend to return the same centroids (centre of mass), while mean and median of x+yi do not (where median returns a point within the cloud, while mean returns the centre of mass).</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># Restricted lengths</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, pch<span class="op">=</span><span class="st">'.'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span>, pch<span class="op">=</span><span class="fl">4</span>, cex<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span>, pch<span class="op">=</span><span class="fl">3</span>, cex<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'blue'</span>, pch<span class="op">=</span><span class="fl">4</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'blue'</span>, pch<span class="op">=</span><span class="fl">3</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_whycomplex_centreofmass-1.png" width="672"></div>
<p>And the centre of the mass – with respect to the origin – can be used to infer asymmetry / anisotropy in the point cloud distribution. Note how the distance from the origin has now increased for this asymmetrical object.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">5</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="co"># Restricted lengths</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">npts</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span></span>
<span><span class="va">cx</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1i</span> <span class="op">*</span> <span class="va">theta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, pch<span class="op">=</span><span class="st">'.'</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span>, pch<span class="op">=</span><span class="fl">4</span>, cex<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span>, pch<span class="op">=</span><span class="fl">3</span>, cex<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'blue'</span>, pch<span class="op">=</span><span class="fl">4</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">cx</span><span class="op">)</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'blue'</span>, pch<span class="op">=</span><span class="fl">3</span>, cex<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_whycomplex_centreofmass_aniso-1.png" width="672"></div>
<p>Summarising, encoding coordinates as complex numbers allow us to quickly and simply obtain useful metrics.</p>
</div>
<div id="the-fast-fourier-transform-fft-and-band-pass-filtering" class="section level4 unnumbered">
<h4>The Fast Fourier Transform (FFT) and band-pass filtering<a class="anchor" aria-label="anchor" href="#the-fast-fourier-transform-fft-and-band-pass-filtering"><i class="fas fa-link"></i></a>
</h4>
<p>The FFT is an incredibly important algorithm that allows conversion of a signal between the time and frequency domains. It is provided in base R.</p>
<p>In the 1D setting, the idea is to decompose a complex wave into a weighted sum of simpler waves. Below we create a complex wave by summing some simple sine waves with different frequencies:</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="va">pi</span></span>
<span><span class="va">wave1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="co">#4Hz</span></span>
<span><span class="va">wave2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="fl">11</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="co">#11Hz</span></span>
<span><span class="va">wave3</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">wave1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">wave2</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">wave1</span>, type<span class="op">=</span><span class="st">'l'</span>, main<span class="op">=</span><span class="st">'Simple wave 1'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">wave2</span>, type<span class="op">=</span><span class="st">'l'</span>, main<span class="op">=</span><span class="st">'Simple wave 2'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">wave3</span>, type<span class="op">=</span><span class="st">'l'</span>, main<span class="op">=</span><span class="st">'The complex wave'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft1d-1.png" width="672"></div>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The output of a FFT decomposition is a vector of complex numbers. Below, we plot the Magnitude (the modulus).</p>
<p>We observe two peaks: one at 4Hz and one at 11Hz – matching the frequencies of the component simple waves. Additionally, the peak at 4Hz is twice as high as the one at 11Hz, matching how the coefficient is twice as big for 4Hz than 11Hz for our synthetic complex wave. [Additionally, note that the Full frequency spectrum is mirrored because our input was comprised wholly of real values (and no imaginary).]</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">wave3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">freq</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">freq</span><span class="op">)</span>, t<span class="op">=</span><span class="st">'h'</span>, xlab <span class="op">=</span> <span class="st">'Frequency (Hz)'</span>, main <span class="op">=</span> <span class="st">'Magnitudes of FFT vector'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">freq</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">freq</span><span class="op">)</span>, t<span class="op">=</span><span class="st">'h'</span>, xlab <span class="op">=</span> <span class="st">'Frequency (Hz)'</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Zoomed in'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft1d_decompose-1.png" width="672"></div>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Importantly, it is possible to convert the wave back from the frequency domain to its original time domain using the inverse FFT.</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wave</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">freq</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">wave3</span>, type<span class="op">=</span><span class="st">'l'</span>, main <span class="op">=</span> <span class="st">'Original wave'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wave</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="va">wave</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wave</span><span class="op">)</span>, t<span class="op">=</span><span class="st">'l'</span>, xlab <span class="op">=</span> <span class="st">'Time (s)'</span>, main <span class="op">=</span> <span class="st">'Wave reconstructed from iFFT'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft1d_reconstruct-1.png" width="672"></div>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The same concept applies to a 2D signal (image). “Frequency” in this context can be thought of as how quickly pixel intensities are changing in small area. [As before, there are both real and imaginary components upon FFT decomposition.]</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create a circle in a plane</span></span>
<span><span class="va">toy_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">201</span>, ncol<span class="op">=</span><span class="fl">201</span><span class="op">)</span></span>
<span><span class="va">toy_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getRasterCoords.html">getRasterCoords</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span></span>
<span><span class="va">centre</span> <span class="op">&lt;-</span> <span class="fl">100</span><span class="op">+</span><span class="fl">100i</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">toy_image</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre</span><span class="op">)</span><span class="op">&lt;=</span><span class="va">r</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">## FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'FFT Log1p Magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_arg</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'FFT Phase'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_syntheticimage-1.png" width="672"></div>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that changing the location of the circle does not affect the Magnitude (but does alter the Phase). [Note: This invariance of Magnitude to coordinate displacements can be exploited for image registration – see the <code>crossCorrelate2D</code> function we use during <code>registerImages</code>.]</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create a circle in a plane</span></span>
<span><span class="va">toy_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">201</span>, ncol<span class="op">=</span><span class="fl">201</span><span class="op">)</span></span>
<span><span class="va">toy_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getRasterCoords.html">getRasterCoords</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span></span>
<span><span class="va">centre</span> <span class="op">&lt;-</span> <span class="fl">50</span><span class="op">+</span><span class="fl">50i</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">toy_image</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre</span><span class="op">)</span><span class="op">&lt;=</span><span class="va">r</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">## FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'FFT Log1p Magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_arg</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'FFT Phase'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_movedimage-1.png" width="672"></div>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In an image processing context, we typically do some rearrangement of the Magnitude matrix – to move the 0Hz frequency component to the centre. This is accomplished in base Matlab and Python’s <code>numpy</code> with <code>fftshift</code> (and to inverse, <code>ifftshift</code>). However, there are no similar functions in base R, so we’ll create a simple version of these functions below:</p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fftshift</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>    </span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>    </span>
<span>  <span class="va">swap_up_down</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rows_half</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">rows</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="va">rows_half</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">rows</span><span class="op">)</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span>, <span class="va">img_ff</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">rows_half</span><span class="op">)</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">swap_left_right</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">cols_half</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">cols</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">rows</span>, <span class="op">(</span><span class="op">(</span><span class="va">cols_half</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span>, <span class="va">img_ff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">rows</span>, <span class="fl">1</span><span class="op">:</span><span class="va">cols_half</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">img_ff</span> <span class="op">&lt;-</span> <span class="fu">swap_up_down</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">swap_left_right</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ifftshift</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>    </span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>    </span>
<span>  <span class="va">swap_up_down</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rows_half</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">rows</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">[</span><span class="op">(</span><span class="op">(</span><span class="va">rows_half</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">rows</span><span class="op">)</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span>, <span class="va">img_ff</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">rows_half</span><span class="op">)</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">swap_left_right</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">cols_half</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">cols</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">img_ff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">rows</span>, <span class="op">(</span><span class="op">(</span><span class="va">cols_half</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">cols</span><span class="op">)</span><span class="op">]</span>, <span class="va">img_ff</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">rows</span>, <span class="fl">1</span><span class="op">:</span><span class="va">cols_half</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">img_ff</span> <span class="op">&lt;-</span> <span class="fu">swap_left_right</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">swap_up_down</span><span class="op">(</span><span class="va">img_ff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Log1p Magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu">fftshift</span><span class="op">(</span><span class="va">im_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Magnitude with fftshift'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift-1.png" width="672"></div>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The purpose of <code>fftshift</code> is to make it easy to modify the image in the frequency domain. For instance, say I care only about low frequencies in my image, I will mainly keep Magnitude values in the centre of the image. [This is similar to simply applying a blur to an image.]</p>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Keep low frequencies only</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">&lt;</span> <span class="fl">10</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu">fftshift</span><span class="op">(</span><span class="va">im_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">new_im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Filtered magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_lowfreq-1.png" width="1152"></div>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And if I want high frequency only…</p>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Keep high frequencies only</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">10</span> <span class="co">#Invert the previous filter</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu">fftshift</span><span class="op">(</span><span class="va">im_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">new_im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Filtered magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_highfreq-1.png" width="1152"></div>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Or if I want some combination of low and high frequency (band-pass filter)…</p>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Keep a mixture of low and high frequencies</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">20</span> <span class="op">)</span> <span class="op">|</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">&lt;</span> <span class="fl">10</span> <span class="op">)</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu">fftshift</span><span class="op">(</span><span class="va">im_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">new_im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Filtered magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_bandpass-1.png" width="1152"></div>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Being creative with your choice of “filter” can result in different results. Below are some examples of filters. Note how filters below are formulated as radial basis functions, and are multiplied by the magnitude.</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Filter</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">filter</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Gaussian filter'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_filters_gaussian-1.png" width="672"></div>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Filter</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">)</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">filter</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Butterworth filter'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_filters_butterworth-1.png" width="672"></div>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># FFT decomposition</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span> </span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Filter</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span> <span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span> <span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="op">-</span><span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">filter</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Laplacian filter'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_recon_filters_laplacian-1.png" width="672"></div>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Being creative with filters can also be useful for removing (or enhancing) artefacts in an image.</p>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create an image with artefacts</span></span>
<span><span class="va">ima</span> <span class="op">&lt;-</span> <span class="va">toy_image</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span><span class="va">ima</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ima</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, replace<span class="op">=</span><span class="cn">FALSE</span>, size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co">## FFT decompose</span></span>
<span><span class="va">im_fft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">ima</span><span class="op">)</span></span>
<span><span class="va">im_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span><span class="va">im_arg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Arg</a></span><span class="op">(</span><span class="va">im_fft</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Filter</span></span>
<span><span class="va">centre_of_image</span> <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">100i</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Im</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre_of_image</span><span class="op">)</span></span>
<span><span class="va">new_im_mod</span> <span class="op">&lt;-</span> <span class="va">filter</span> <span class="op">*</span> <span class="fu">fftshift</span><span class="op">(</span> <span class="va">im_mod</span> <span class="op">)</span></span>
<span><span class="va">new_fft</span> <span class="op">&lt;-</span> <span class="fu">ifftshift</span><span class="op">(</span> <span class="va">new_im_mod</span> <span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="fl">1i</span> <span class="op">*</span> <span class="va">im_arg</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Image reconstruction</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fft.html">fft</a></span><span class="op">(</span><span class="va">new_fft</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">im_recon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">im_recon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">ima</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu">fftshift</span><span class="op">(</span><span class="va">im_mod</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">new_im_mod</span><span class="op">)</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Filtered magnitude'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">im_recon</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Reconstructed image'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_fft2d_fftshift_artifactremoval-1.png" width="1152"></div>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This concludes a very brief introduction to one of the many uses of the FFT algorithm.</p>
</div>
<div id="convolution-of-images-with-kernels" class="section level4 unnumbered">
<h4>Convolution of images with kernels<a class="anchor" aria-label="anchor" href="#convolution-of-images-with-kernels"><i class="fas fa-link"></i></a>
</h4>
<p>No discussion of image processing would be complete without mentioning the use of kernels. Kernels are small matrices that are applied pixel by pixel on an image. These kernels contain weights that are multiplied by the underlying pixel intensity, then summed to return a new value for the central element of the kernel matrix. The effect is a weighted sum of pixel intensities across a small area. Choosing different kernels perform different calculations.</p>
<p>Kernel methods are very flexible and can be executed very quickly (with far less computation compared to other approaches).</p>
<p>For instance, take Gaussian blurring (which we can also accomplish with <code><a href="https://rdrr.io/pkg/imager/man/isoblur.html">imager::isoblur</a></code> or the FFT method above). Using the kernel approach, we calculated a weighted average of pixel intensities.</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create image</span></span>
<span><span class="va">toy_image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="fl">21</span>, ncol<span class="op">=</span><span class="fl">21</span><span class="op">)</span></span>
<span><span class="va">toy_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getRasterCoords.html">getRasterCoords</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span></span>
<span><span class="va">centre</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">+</span><span class="fl">10i</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">toy_image</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html">Mod</a></span><span class="op">(</span><span class="va">toy_coord</span> <span class="op">-</span> <span class="va">centre</span><span class="op">)</span><span class="op">&lt;=</span><span class="va">r</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>  <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">2</span>,</span>
<span>  <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span></span>
<span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="va">kernel</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span> <span class="co">#Normalize so sum is 1</span></span>
<span><span class="va">kernel_blur1</span> <span class="op">&lt;-</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/correlate.html">convolve</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">1</span>,</span>
<span>  <span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">24</span>, <span class="fl">16</span>, <span class="fl">4</span>,</span>
<span>  <span class="fl">6</span>, <span class="fl">24</span>, <span class="fl">36</span>, <span class="fl">24</span>, <span class="fl">6</span>,</span>
<span>  <span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">24</span>, <span class="fl">16</span>, <span class="fl">4</span>,</span>
<span>  <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">4</span>, <span class="fl">1</span></span>
<span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">5</span>, byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="va">kernel</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span> <span class="co">#Normalize so sum is 1</span></span>
<span><span class="va">kernel_blur2</span> <span class="op">&lt;-</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/correlate.html">convolve</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">kernel_blur1</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Kernel blur (3x3)'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">kernel_blur2</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Kernel blur (5x5)'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_convolution_gaussianblurring-1.png" width="672"></div>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And of course, your choice of kernel will have different effects: for instance, see the Laplace operator below (used for edge detection). [Note the sum of the kernel is 0, so no need to normalize here.]</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="op">-</span><span class="fl">1</span>, <span class="fl">8</span>, <span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">kernel_blur1</span> <span class="op">&lt;-</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/correlate.html">convolve</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">toy_image</span><span class="op">)</span>, <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">toy_image</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Original image'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">kernel_blur1</span> <span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">F</span>, main <span class="op">=</span> <span class="st">'Laplace operator'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-advances_convolution_laplaceoperator-1.png" width="672"></div>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>See <a href="https://en.wikipedia.org/wiki/Kernel_(image_processing)" class="uri">https://en.wikipedia.org/wiki/Kernel_(image_processing)</a> for more examples of kernels and their uses.</p>
</div>
</div>
<div id="combining-building-blocks" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Combining building blocks<a class="anchor" aria-label="anchor" href="#combining-building-blocks"><i class="fas fa-link"></i></a>
</h2>
<p>Using the building blocks above, and any relevant functions from {imager} or {EBImage}, users can create complex image processing pipelines. Below is an example of a composite function <code>imLowPass</code> created using a combination of <code>imNormalise</code>, image blurring, and <code>imAutoBrighten</code>.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">masmr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/masmr/man/imLowPass.html">imLowPass</a></span></span></code></pre></div>
<pre><code>## function (im, smallBlur, currentIteration, ...) 
## {
##     if (!missing(currentIteration)) {
##         message(currentIteration, appendLF = F)
##     }
##     if (missing(smallBlur)) {
##         smallBlur = 1
##     }
##     background &lt;- imNormalise(im, ...) == 0
##     imblur &lt;- array(imager::isoblur(suppressWarnings(imager::as.cimg(im)), 
##         smallBlur), dim = dim(im))
##     lowthresh &lt;- median(imblur[background])
##     hithresh &lt;- median(imblur[!background &amp; (imblur &gt; lowthresh)])
##     if (((lowthresh &gt; 0) &amp; (hithresh &lt; 1) &amp; (lowthresh &lt; hithresh) &amp; 
##         !is.na(lowthresh) &amp; !is.na(hithresh))) {
##         norm &lt;- imAutoBrighten(imblur, floorVal = lowthresh, 
##             ceilVal = hithresh)
##     }
##     else {
##         warning(paste0("Skipping imAutoBrighten because of invalid floorVal (", 
##             lowthresh, ") and/or ceilVal (", hithresh, ")..."))
##         norm &lt;- imblur
##     }
##     norm &lt;- imNormalise(norm)
##     return(norm)
## }
## &lt;bytecode: 0x00000242cc04f948&gt;
## &lt;environment: namespace:masmr&gt;</code></pre>
<p><strong>ALWAYS plot to check how your image processing has altered your image!</strong></p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLowPass.html">imLowPass</a></span><span class="op">(</span><span class="va">im</span>, floorVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_min</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ceilVal <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">brightness_max</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Low pass'</span> <span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in as.cimg.array(norm): Assuming third dimension corresponds to time/depth</code></pre>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span> <span class="va">norm</span>, breaks<span class="op">=</span><span class="fl">1000</span>, main <span class="op">=</span> <span class="st">'Low pass'</span>, xlab<span class="op">=</span><span class="st">'Intensities'</span>, ylab<span class="op">=</span><span class="st">'N pixels'</span> <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-lowpass-1.png" width="672"></div>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="building-your-own-function-an-example" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Building your own function: an example<a class="anchor" aria-label="anchor" href="#building-your-own-function-an-example"><i class="fas fa-link"></i></a>
</h2>
<p>Users are strongly encouraged to experiment with the provided image processing functions and create their own image processing pipelines if necessary. Below, we provide an example of how a custom function may be built.</p>
<p>Say we are dissatisfied with the current default masking function (<code>imForMask</code>), whose purpose is to flag pixels where we suspect a spot to be, as being too restrictive (i.e. only flagging the strongest signals).</p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## The original image is a bit too dim for visualisation: but will provide here for completeness</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">)</span>, main<span class="op">=</span><span class="st">'Original'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-defaultmasking-1.png" width="672"></div>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">0.1</span> <span class="op">)</span>, main<span class="op">=</span><span class="st">'Original (brightened)'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imForMask.html">imForMask</a></span><span class="op">(</span><span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">)</span>, main<span class="op">=</span><span class="st">'Default mask'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-defaultmasking-2.png" width="672"></div>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>First, let’s have a look at what <code>imForMask</code> is doing. From below, we see that it takes in a single image <code>im</code> and…</p>
<ol style="list-style-type: decimal">
<li>Low pass filtering of an image with the <code>imLowPass</code> function: returning <code>lowpass</code>
</li>
<li>Calculates the determinant of the Hessian (<code>imNormalise %&gt;% imHessianDeterminant %&gt;% isoblur</code>): returning <code>dethessb</code>
</li>
<li>Calculates the Laplacian of the Gaussian (<code>imNormalise %&gt;% imLaplacianOfGaussian</code>): returning <code>LoG</code>
</li>
<li>Masking of <code>LoG</code> and <code>dethessb</code> by identifying appropriate thresholds (<code>findThreshold</code>)</li>
<li>Scoring of pixels between 0 and 1 using the product of <code>lowpass</code> and <code>LoG</code>, with saturated pixels (<code>norm==1</code> or <code>im==1</code>) being set to max score</li>
<li>Flagging saturated pixels (<code>im==1</code>), pixels with superthreshold <code>LoG</code>, or pixels with superthreshold <code>dethessb</code>: returning <code>lab</code> (<code>1</code> if yes to any of the three criteria, otherwise <code>0</code>)</li>
<li>Finding the threshold for scores calculated in step (5) that separate <code>1</code> and <code>0</code> from <code>lab</code> in step 6: returning <code>mask</code>
</li>
<li>Size filter of <code>mask</code> to remove masks smaller than <code>minBlobSize</code> pixels</li>
</ol>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">masmr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/masmr/man/imForMask.html">imForMask</a></span></span></code></pre></div>
<pre><code>## function (im, smallBlur, minBlobSize, currentIteration, ...) 
## {
##     if (!missing(currentIteration)) {
##         message(currentIteration, appendLF = F)
##     }
##     if (missing(smallBlur)) {
##         smallBlur = 1
##     }
##     if (missing(minBlobSize)) {
##         minBlobSize = 9
##     }
##     norm &lt;- imNormalise(im, ...)
##     lowpass &lt;- imLowPass(norm, ...)
##     dethess &lt;- imHessianDeterminant(norm, ...)
##     dethess &lt;- imNormalise(dethess)
##     dethessb &lt;- array(imager::isoblur(suppressWarnings(imager::as.cimg(dethess)), 
##         smallBlur), dim = dim(im))
##     vals &lt;- dethessb[dethessb &gt; quantile(dethessb, 0.95)]
##     dethessbFloor &lt;- findThreshold(vals, method = thresh_Elbow, 
##         ...)
##     LoG &lt;- imLaplacianOfGaussian(norm, ...)
##     LoGthresh &lt;- findThreshold(LoG[LoG &gt; 0], method = thresh_Elbow, 
##         ...)
##     vals &lt;- imNormalise(lowpass * imNormalise(LoG, floorVal = LoGthresh, 
##         ceilVal = max(LoG)))
##     vals[((im &gt;= 1) + (norm &gt;= 1)) &gt; 0] &lt;- 1
##     lab &lt;- ((LoG &gt; LoGthresh) + (dethessb &gt; dethessbFloor) + 
##         (im == 1)) &gt; 0
##     thresh &lt;- findThreshold(vals, method = thresh_Quantile, labels = lab, 
##         ...)
##     mask &lt;- vals &gt; thresh
##     labmask &lt;- EBImage::bwlabel(mask)
##     toosmall &lt;- which(tabulate(labmask) &lt; minBlobSize)
##     mask[labmask %in% toosmall] &lt;- F
##     return(mask)
## }
## &lt;bytecode: 0x000002424e45c7b0&gt;
## &lt;environment: namespace:masmr&gt;</code></pre>
<p>Next, let’s create a new mask function that will be more permissive and flag more pixels. This <code>myCustomMask</code> function is created from copying and editing the default <code>imForMask</code> function above. Briefly, this new function replaces steps 5-7 in the default <code>imForMask</code> function with the union of multiple masks.</p>
<p>[Note: the use of ellipsis (<code>...</code>) is to allow the passing arguments in <code>myCustomMask</code> to functions <strong>within</strong> <code>myCustomMask</code>: e.g. <code>imLaplacianOfGaussian</code>, <code>imHessianDeterminant</code> etc.]</p>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myCustomMask</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">im</span>, <span class="va">smallBlur</span>, <span class="va">minBlobSize</span>, <span class="va">currentIteration</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">currentIteration</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="va">currentIteration</span>, appendLF <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">smallBlur</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">smallBlur</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">minBlobSize</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">minBlobSize</span> <span class="op">=</span> <span class="fl">9</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co">## Old code: Calculate scores per pixel as per the default imForMask function</span></span>
<span>    <span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">lowpass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLowPass.html">imLowPass</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">dethess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">norm</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">dethess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">dethess</span><span class="op">)</span></span>
<span>    <span class="va">dethessb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/isoblur.html">isoblur</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">dethess</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="va">smallBlur</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="va">dethessb</span><span class="op">[</span><span class="va">dethessb</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">dethessb</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">dethessbFloor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">vals</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, </span>
<span>        <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">LoG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">norm</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">LoGthresh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">LoG</span><span class="op">[</span><span class="va">LoG</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, </span>
<span>        <span class="va">...</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## New code: also get LoG values for the lowpass image</span></span>
<span>    <span class="va">LoGLowPass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">norm</span> <span class="op">*</span> <span class="va">lowpass</span><span class="op">)</span></span>
<span>    <span class="va">LoGthreshLowPass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">LoG</span><span class="op">[</span><span class="va">LoG</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## New code: Union of masks</span></span>
<span>    <span class="va">mask</span> <span class="op">&lt;-</span> </span>
<span>      <span class="op">(</span><span class="va">LoG</span><span class="op">&gt;</span><span class="va">LoGthresh</span><span class="op">)</span> <span class="op">+</span>               <span class="co">#LoG of original image above threshold</span></span>
<span>      <span class="op">(</span><span class="va">LoGLowPass</span><span class="op">&gt;</span><span class="va">LoGthreshLowPass</span><span class="op">)</span> <span class="op">+</span> <span class="co">#LoG of lowpass image above threshold</span></span>
<span>      <span class="op">(</span><span class="va">dethessb</span><span class="op">&gt;</span><span class="va">dethessbFloor</span><span class="op">)</span> <span class="op">+</span>      <span class="co">#detHess above threshold</span></span>
<span>      <span class="op">(</span><span class="va">im</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>                         <span class="co">#Saturated pixels</span></span>
<span>    <span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">mask</span> <span class="op">&gt;</span> <span class="fl">0</span>                  <span class="co">#Inclusive Or</span></span>
<span>    <span class="va">allmask</span> <span class="op">&lt;-</span> <span class="va">mask</span></span>
<span>    </span>
<span>    <span class="co">## Old code: Filter out masks that are too small</span></span>
<span>    <span class="va">labmask</span> <span class="op">&lt;-</span> <span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/bwlabel.html">bwlabel</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span></span>
<span>    <span class="va">toosmall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tabulate.html">tabulate</a></span><span class="op">(</span><span class="va">labmask</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">minBlobSize</span><span class="op">)</span></span>
<span>    <span class="va">mask</span><span class="op">[</span><span class="va">labmask</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">toosmall</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">F</span></span>
<span>    <span class="va">final</span> <span class="op">&lt;-</span> <span class="va">mask</span></span>
<span>    </span>
<span>    <span class="co">## If function ready, just return final</span></span>
<span>    <span class="co"># return(final)</span></span>
<span>    </span>
<span>    <span class="co">## If troubleshooting, return all intermediate images</span></span>
<span>    <span class="va">processedImages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="st">'Norm'</span> <span class="op">=</span> <span class="va">norm</span>,</span>
<span>      <span class="st">'LowPass'</span> <span class="op">=</span> <span class="va">lowpass</span>,</span>
<span>      <span class="st">'detHess'</span> <span class="op">=</span> <span class="va">dethessb</span>,</span>
<span>      <span class="st">'detHess masked'</span> <span class="op">=</span> <span class="va">dethessb</span><span class="op">&gt;</span><span class="va">dethessbFloor</span>,</span>
<span>      <span class="st">'LoG'</span> <span class="op">=</span> <span class="va">LoG</span>,</span>
<span>      <span class="st">'LoG masked'</span> <span class="op">=</span> <span class="va">LoG</span><span class="op">&gt;</span><span class="va">LoGthresh</span>,</span>
<span>      <span class="st">'LowPass LoG'</span> <span class="op">=</span> <span class="va">LoGLowPass</span>,</span>
<span>      <span class="st">'LowPass LoG masked'</span> <span class="op">=</span> <span class="va">LoGLowPass</span><span class="op">&gt;</span><span class="va">LoGthreshLowPass</span>,</span>
<span>      <span class="st">'All masks'</span> <span class="op">=</span> <span class="va">allmask</span>,</span>
<span>      <span class="st">'Masks after size filter'</span> <span class="op">=</span> <span class="va">mask</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="va">processedImages</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">processedImages</span> <span class="op">&lt;-</span> <span class="fu">myCustomMask</span><span class="op">(</span> <span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">imMetricName</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">processedImages</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">processedImages</span><span class="op">[[</span><span class="va">imMetricName</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">)</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="va">imMetricName</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-defaultmaskingreplaced-1.png" width="576"></div>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When satisfied with the custom function, returning intermediate images can be skipped:</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myCustomMask</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">im</span>, <span class="va">smallBlur</span>, <span class="va">minBlobSize</span>, <span class="va">currentIteration</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">currentIteration</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="va">currentIteration</span>, appendLF <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">smallBlur</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">smallBlur</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">minBlobSize</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">minBlobSize</span> <span class="op">=</span> <span class="fl">9</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co">## Calculate scores per pixel as per the default imForMask function</span></span>
<span>    <span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">lowpass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLowPass.html">imLowPass</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">dethess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imHessianDeterminant.html">imHessianDeterminant</a></span><span class="op">(</span><span class="va">norm</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">dethess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imNormalise.html">imNormalise</a></span><span class="op">(</span><span class="va">dethess</span><span class="op">)</span></span>
<span>    <span class="va">dethessb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/isoblur.html">isoblur</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span><span class="va">dethess</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="va">smallBlur</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="va">dethessb</span><span class="op">[</span><span class="va">dethessb</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">dethessb</span>, <span class="fl">0.95</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">dethessbFloor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">vals</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, </span>
<span>        <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">LoG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">norm</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">LoGthresh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">LoG</span><span class="op">[</span><span class="va">LoG</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, </span>
<span>        <span class="va">...</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## New: also get LoG values for the lowpass image</span></span>
<span>    <span class="va">LoGLowPass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/imLaplacianOfGaussian.html">imLaplacianOfGaussian</a></span><span class="op">(</span><span class="va">norm</span> <span class="op">*</span> <span class="va">lowpass</span><span class="op">)</span></span>
<span>    <span class="va">LoGthreshLowPass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/masmr/man/findThreshold.html">findThreshold</a></span><span class="op">(</span><span class="va">LoG</span><span class="op">[</span><span class="va">LoG</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, method <span class="op">=</span> <span class="va">thresh_Elbow</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## Union of masks</span></span>
<span>    <span class="va">mask</span> <span class="op">&lt;-</span> </span>
<span>      <span class="op">(</span><span class="va">LoG</span><span class="op">&gt;</span><span class="va">LoGthresh</span><span class="op">)</span> <span class="op">+</span>               <span class="co">#LoG of original image above threshold</span></span>
<span>      <span class="op">(</span><span class="va">LoGLowPass</span><span class="op">&gt;</span><span class="va">LoGthreshLowPass</span><span class="op">)</span> <span class="op">+</span> <span class="co">#LoG of lowpass image above threshold</span></span>
<span>      <span class="op">(</span><span class="va">dethessb</span><span class="op">&gt;</span><span class="va">dethessbFloor</span><span class="op">)</span> <span class="op">+</span>      <span class="co">#detHess above threshold</span></span>
<span>      <span class="op">(</span><span class="va">im</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>                         <span class="co">#Saturated pixels</span></span>
<span>    <span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">mask</span> <span class="op">&gt;</span> <span class="fl">0</span>                  <span class="co">#Inclusive Or</span></span>
<span>    <span class="va">allmask</span> <span class="op">&lt;-</span> <span class="va">mask</span></span>
<span>    </span>
<span>    <span class="co">## Filter out masks that are too small</span></span>
<span>    <span class="va">labmask</span> <span class="op">&lt;-</span> <span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/bwlabel.html">bwlabel</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span></span>
<span>    <span class="va">toosmall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tabulate.html">tabulate</a></span><span class="op">(</span><span class="va">labmask</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">minBlobSize</span><span class="op">)</span></span>
<span>    <span class="va">mask</span><span class="op">[</span><span class="va">labmask</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">toosmall</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">F</span></span>
<span>    <span class="va">final</span> <span class="op">&lt;-</span> <span class="va">mask</span></span>
<span>    </span>
<span>    <span class="co">## If function ready, just return final</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">final</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## If troubleshooting, return all intermediate images</span></span>
<span>    <span class="co"># processedImages &lt;- list(</span></span>
<span>    <span class="co">#   'Norm' = norm,</span></span>
<span>    <span class="co">#   'LowPass' = lowpass,</span></span>
<span>    <span class="co">#   'detHess' = dethessb,</span></span>
<span>    <span class="co">#   'detHess masked' = dethessb&gt;dethessbFloor,</span></span>
<span>    <span class="co">#   'LoG' = LoG,</span></span>
<span>    <span class="co">#   'LoG masked' = LoG&gt;LoGthresh,</span></span>
<span>    <span class="co">#   'LowPass LoG' = LoGLowPass,</span></span>
<span>    <span class="co">#   'LowPass LoG masked' = LoGLowPass&gt;LoGthreshLowPass,</span></span>
<span>    <span class="co">#   'All masks' = allmask,</span></span>
<span>    <span class="co">#   'Masks after size filter' = mask</span></span>
<span>    <span class="co"># )</span></span>
<span>    <span class="co"># return( processedImages )</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">0.1</span> <span class="op">)</span>, main<span class="op">=</span><span class="st">'Original (brightened)'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="fu">myCustomMask</span><span class="op">(</span><span class="va">imList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">)</span>, main<span class="op">=</span><span class="st">'Custom mask'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-myCustomMaskShowcase-1.png" width="672"></div>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Voila! A new custom masking function.</p>
<p>Having explained how to create a custom function, we will discuss how these custom functions can be looped through their image list.</p>
</div>
<div id="feeding-image-processing-pipelines-into-getimagemetrics" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Feeding image processing pipelines into <code>getImageMetrics</code><a class="anchor" aria-label="anchor" href="#feeding-image-processing-pipelines-into-getimagemetrics"><i class="fas fa-link"></i></a>
</h2>
<p>By listing looping functions in a named list <code>imageFunctions</code> (much like what is done for <code>getAnchorParams</code>), users can perform different types of image processing using our <code>getImageMetrics</code> function. The result is a new environment object (<code>imMetrics</code>) that houses image lists that have been processed in different ways. As default, the following image processing is performed:</p>
<ul>
<li>
<code>ORIG</code>: unprocessed images.</li>
<li>
<code>NORM</code>: images that have been min-max normalised.</li>
<li>
<code>COARSE</code>: low-pass images, optimised to separate foreground from background.</li>
<li>
<code>DECODE</code>: images that have been optimised for decoding.</li>
<li>
<code>MASK</code>: images where pixels worth bringing forward for decoding have been masked as <code>TRUE</code>.</li>
</ul>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getImageMetrics.html">getImageMetrics</a></span><span class="op">(</span> </span>
<span>  <span class="va">imList</span>,</span>
<span>  imageFunctions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">'ORIG'</span> <span class="op">=</span> <span class="va">imReturn</span>,</span>
<span>    <span class="st">'NORM'</span> <span class="op">=</span> <span class="va">imWinsorIntensities</span>,</span>
<span>    <span class="st">'COARSE'</span> <span class="op">=</span> <span class="va">imLowPass</span>,</span>
<span>    <span class="st">'DECODE'</span> <span class="op">=</span> <span class="va">imForDecode</span>,</span>
<span>    <span class="st">'MASK'</span> <span class="op">=</span> <span class="va">imForMask</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>ALWAYS plot to check how your image processing has altered your image!</strong></p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">imMetricName</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="va">imMetrics</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">imager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html">as.cimg</a></span><span class="op">(</span> <span class="va">imMetrics</span><span class="op">[[</span><span class="va">imMetricName</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">)</span>, main <span class="op">=</span> <span class="va">imMetricName</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/improc-imagemetrics-zoomed-1.png" width="672"></div>
<p>Users can do the same, and visualise how their function performs on one FOV. When satisfied, that custom function can be looped through all images in the <code>imList</code> with <code>getImageMetrics</code>:</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">userCustomFunction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span> <span class="va">im</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">## User to decide on how they want the image to be processed</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Loop the custom function across all images</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getImageMetrics.html">getImageMetrics</a></span><span class="op">(</span> </span>
<span>  <span class="va">imList</span>,</span>
<span>  imageFunctions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">'ORIG'</span> <span class="op">=</span> <span class="va">imReturn</span>,</span>
<span>    <span class="st">'NORM'</span> <span class="op">=</span> <span class="va">imWinsorIntensities</span>,</span>
<span>    <span class="st">'COARSE'</span> <span class="op">=</span> <span class="va">imLowPass</span>,</span>
<span>    <span class="st">'DECODE'</span> <span class="op">=</span> <span class="va">imForDecode</span>,</span>
<span>    <span class="st">'MASK'</span> <span class="op">=</span> <span class="va">imForMask</span>,</span>
<span>    <span class="st">'CUSTOM'</span> <span class="op">=</span> <span class="va">userCustomFunction</span> <span class="co">#New function  (or replace one of the above with your new function)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>It is important to note that <code>imMetrics$MASK</code> will determine which pixels are brought forwards for decoding during the later <code>consolidateImageMetrics</code> function; and that decoding will be performed on <code>imMetrics$DECODE</code>. The <code>DECODE</code> and <code>MASK</code> metrics should thus be the image processing pipelines that users should focus on when optimising.</p>
<p>If users want to decode on the whole image (which may be memory intensive), removing <code>MASK</code> from <code>imMetrics</code> (an example below), or creating a <code>imMetrics$MASK</code> with <code>TRUE</code> for every pixel will work. In so doing, spotcalling will only depend on the <code>DECODE</code> images.</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myCustomMask</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="va">im</span> <span class="op">&gt;</span> <span class="op">-</span><span class="cn">Inf</span> <span class="op">)</span> <span class="co">#Return TRUE for every pixel</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/masmr/man/getImageMetrics.html">getImageMetrics</a></span><span class="op">(</span> </span>
<span>  <span class="va">imList</span>,</span>
<span>  imageFunctions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">'ORIG'</span> <span class="op">=</span> <span class="va">imReturn</span>,</span>
<span>    <span class="st">'NORM'</span> <span class="op">=</span> <span class="va">imWinsorIntensities</span>,</span>
<span>    <span class="st">'COARSE'</span> <span class="op">=</span> <span class="va">imLowPass</span>,</span>
<span>    <span class="st">'DECODE'</span> <span class="op">=</span> <span class="va">imForDecode</span>,</span>
<span>    <span class="st">'MASK'</span> <span class="op">=</span> <span class="va">myCustomMask</span> <span class="co">#User replacing the mask function</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Alternatively, users can remove the MASK</span></span>
<span><span class="va">imMetrics</span><span class="op">$</span><span class="va">MASK</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Experiment and find what works for your dataset. Don’t forget to make use of functions like <code>filterDF</code> and <code>spotcall_troubleshootPlots</code> to help you troubleshoot (see Chapter <a href="spotcalling.html#spotcalling">3</a>).</p>
<p><strong>Users are encouraged to optimise their image processing pipelines on one FOV, before applying the same pipelines to all other FOVs.</strong></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="spotcalling.html"><span class="header-section-number">3</span> Spotcalling</a></div>
<div class="next"><a href="cell-segmentation.html"><span class="header-section-number">5</span> Cell segmentation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#image-processing"><span class="header-section-number">4</span> Image processing</a></li>
<li><a class="nav-link" href="#pre-processing-1"><span class="header-section-number">4.1</span> Pre-processing</a></li>
<li>
<a class="nav-link" href="#building-blocks-of-image-processing"><span class="header-section-number">4.2</span> Building blocks of image processing</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#imnormalise">imNormalise</a></li>
<li><a class="nav-link" href="#imautobrighten">imAutobrighten</a></li>
<li><a class="nav-link" href="#imlaplacianofgaussian">imLaplacianOfGaussian</a></li>
<li><a class="nav-link" href="#imhessiandeterminant">imHessianDeterminant</a></li>
</ul>
</li>
<li><a class="nav-link" href="#advanced-creating-your-own-building-blocks"><span class="header-section-number">4.3</span> Advanced: creating your own building blocks</a></li>
<li><a class="nav-link" href="#combining-building-blocks"><span class="header-section-number">4.4</span> Combining building blocks</a></li>
<li><a class="nav-link" href="#building-your-own-function-an-example"><span class="header-section-number">4.5</span> Building your own function: an example</a></li>
<li><a class="nav-link" href="#feeding-image-processing-pipelines-into-getimagemetrics"><span class="header-section-number">4.6</span> Feeding image processing pipelines into getImageMetrics</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>masmr: Modular Algorithms for Spotcalling in MERFISH in R</strong>" was written by Eugene Kwa. It was last built on 2025-07-18.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
